<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🎃 Halloween Quest</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0c0c0c;
      color: #fff;
      text-align: center;
    }
    h1 {
      margin-top: 30px;
      color: orange;
    }
    .quest-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 40px;
    }
    .quest {
      background: #1b1b1b;
      padding: 15px;
      border-radius: 10px;
      width: 200px;
      box-shadow: 0 0 10px rgba(255, 165, 0, 0.3);
    }
    .quest img {
      width: 100%;
      border-radius: 10px;
    }
    button {
      background: orange;
      border: none;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      color: #000;
      font-weight: bold;
    }
    button:disabled {
      background: gray;
      cursor: not-allowed;
    }
    .popup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
    }
    .popup-content {
      background: #1b1b1b;
      padding: 25px;
      border-radius: 10px;
      width: 300px;
    }
    #userInfo {
      position: fixed;
      top: 10px;
      right: 20px;
      background: #1b1b1b;
      padding: 10px 15px;
      border-radius: 8px;
      color: orange;
      font-weight: bold;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <h1>🎃 Halloween Quest 🎃</h1>
  <div id="userInfo"></div>

  <!-- Popup för login -->
  <div id="loginPopup" class="popup">
    <div class="popup-content">
      <p>Du måste vara inloggad för att nå denna sida.</p>
      <button onclick="window.location.href='index.html'">Tillbaka</button>
    </div>
  </div>

  <!-- Quest Container -->
  <div class="quest-container" id="questContainer"></div>

  <!-- Quest Popup -->
  <div id="questPopup" class="popup">
    <div class="popup-content">
      <h3 id="questTitle"></h3>
      <p id="questInstructions"></p>
      <input type="text" id="questCodeInput" placeholder="Skriv kod här">
      <br><br>
      <button id="confirmCodeBtn">Bekräfta</button>
      <button onclick="closePopup()">Stäng</button>
    </div>
  </div>

  <!-- Success Popup -->
  <div id="successPopup" class="popup">
    <div class="popup-content">
      <h2>🎉 Grattis! 🎉</h2>
      <p>Du har klarat alla 5 quests!</p>
      <p>Maila <strong>support@windskore.se</strong> för att få en 5% rabbatkod som pris.</p>
      <button onclick="closeSuccessPopup()">Stäng</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBp9mtBNZAt4PLVPV0ReJ1TmdhfsuArXZI",
      authDomain: "windskore.firebaseapp.com",
      projectId: "windskore",
      storageBucket: "windskore.firebasestorage.app",
      messagingSenderId: "894555057184",
      appId: "1:894555057184:web:ae683773015933f6db2045"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const questContainer = document.getElementById("questContainer");
    const loginPopup = document.getElementById("loginPopup");
    const userInfo = document.getElementById("userInfo");
    const questPopup = document.getElementById("questPopup");
    const questCodeInput = document.getElementById("questCodeInput");
    const questTitle = document.getElementById("questTitle");
    const questInstructions = document.getElementById("questInstructions");
    const confirmCodeBtn = document.getElementById("confirmCodeBtn");

    const successPopup = document.getElementById("successPopup");

    let unlockedQuests = [1, 2];

const quests = [
  { 
    id: 1, 
    img: "Halloween-Picture-1.png", 
    code: "7206",
    description: "Någonstans på hemsidan finns en gömd kod – fyra siffror – som låser upp ditt quest. Leta noga!"
  },
  { 
    id: 2, 
    img: "Halloween-Picture-2.png", 
    code: "MÖRKT",
    description: "Spela det nya Halloween Wordle på hemsidan och gissa rätt ord. När du klarar det, skriv in koden här. Du kan spela det här: windskore.se/Spela/Wordle/Index.html"
  },
  { id: 3, img: "Halloween-Picture-3.png", code: "0000", description: "Beskrivning för Quest 3 kommer snart." },
  { id: 4, img: "Halloween-Picture-4.png", code: "0000", description: "Beskrivning för Quest 4 kommer snart." },
  { id: 5, img: "Halloween-Picture-5.png", code: "0000", description: "Beskrivning för Quest 5 kommer snart." },
];

    let currentQuest = null;
    let completed = [];

    function openQuest(id) {
      const quest = quests.find(q => q.id === id);
      currentQuest = quest;
      questTitle.textContent = "Quest " + id;
      questInstructions.textContent = quest.description;
      questCodeInput.value = "";
      questPopup.style.display = "flex";
    }

    function closePopup() {
      questPopup.style.display = "none";
    }

    function showSuccessPopup() {
      successPopup.style.display = "flex";
    }

    function closeSuccessPopup() {
      successPopup.style.display = "none";
    }

    confirmCodeBtn.addEventListener("click", async () => {
      if (!currentQuest) return;
      const code = questCodeInput.value.trim();
      if (code === currentQuest.code) {
        if (!completed.includes(currentQuest.id)) {
          completed.push(currentQuest.id);
          await updateProgress();
          renderQuests();
          closePopup();

          // Visa popup endast om alla quests är klara
          if (completed.length === quests.length) {
            showSuccessPopup();
          }
        }
      } else {
        alert("❌ Fel kod! Försök igen.");
      }
    });

    async function updateProgress() {
      const user = auth.currentUser;
      if (!user) return;
      const ref = doc(db, "users", user.uid);
      await updateDoc(ref, { completedQuests: completed });
    }

    function renderQuests() {
      questContainer.innerHTML = "";
      quests.forEach(q => {
        const div = document.createElement("div");
        div.className = "quest";
        const img = document.createElement("img");
        img.src = q.img;

        const status = document.createElement("p");

        if (completed.includes(q.id)) {
          status.textContent = "✅ Avklarat";
        } else if (unlockedQuests.includes(q.id)) {
          const btn = document.createElement("button");
          btn.textContent = "Gör Quest";
          btn.addEventListener("click", () => openQuest(q.id));
          status.appendChild(btn);
        } else {
          status.textContent = "🔒 Låst";
        }

        div.appendChild(img);
        div.appendChild(status);
        questContainer.appendChild(div);
      });
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        loginPopup.style.display = "flex";
      } else {
        userInfo.textContent = `Inloggad som: ${user.email}`;
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);

        if (snap.exists()) {
          completed = snap.data().completedQuests || [];
        } else {
          await setDoc(ref, { completedQuests: [] });
          completed = [];
        }

        renderQuests();
      }
    });
  </script>
</body>
</html>
